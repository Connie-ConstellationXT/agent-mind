<!-- Refactored Omelette Recipe using Enhanced Element Type Catalog Design -->
<IntentDOM root="MakeOmelette">
  <Precept name="MakeOmelette">
    <Description>Prepare and cook a basic cheese omelette</Description>
    <Domains>
      <Domain ref="food_preparation" />
      <Domain ref="kitchen" />
      <Domain ref="cooking_equipment" />
      <Domain ref="food_safety" />
      <Domain ref="flavor_quality" />
      <Domain type="culture" ref="FrenchCuisine" />
    </Domains>

    <Output format="cooked_dish">Ready-to-eat omelette on plate
      <Artifact name="finished_omelette">
        <Type>instrument</Type>
        <Type>food_item</Type>
        <Type>validation_data</Type>
        <Type>state_vector</Type>
        <Description>Completed omelette plated and ready to serve</Description>
        <Source ref="execution:finishing" />
      </Artifact>
    </Output>
    
    <RequiredInstrument instrumentName="eggs" quantity="2-3" />
    <RequiredInstrument instrumentName="cheese" type="grated" quantity="50g" />
    <RequiredInstrument instrumentName="butter" quantity="1tbsp" />
    <RequiredInstrument instrumentName="salt" />
    <RequiredInstrument instrumentName="black_pepper" />
    <RequiredInstrument instrumentName="non_stick_pan" alias="pan"/>
    <RequiredInstrument instrumentName="spatula" />
    
    <Constraint type="temperature">Medium heat throughout cooking</Constraint>
    <Constraint type="timing">Total cook time 3-4 minutes</Constraint>
    
    <!-- Preflight Staging: Automatic validation when MakeOmelette is imported -->
    <StagingPhase type="preflight" name="quality_assurance">
      <Description>Quality assurance checks before ingredient preparation</Description>
      <ValidateInstrumentCondition instrument="eggs" conditionSet="freshness">
        <Precept name="TestEggFreshness" domain="food_safety">
          <Description>Perform canonical water float test to verify egg quality</Description>
          <RequiredInstrument instrumentName="clear_bowl" />
          <RequiredInstrument instrumentName="water" temperature="room_temp" />
          
          <Precept name="FillBowl" with="water" depth="sufficient_to_submerge_egg" />
          <Precept name="SubmergeEgg" ref="first_egg" into="water_bowl" />
          
          <Precept name="ObserveFloat">
            <AcceptanceCriteria>
              <Condition state="fresh" test="egg_sinks_lies_flat" action="Proceed with this egg" />
              <Condition state="questionable" test="egg_stands_upright" action="Use within today only" />
              <Condition state="spoiled" test="egg_floats" action="Discard and select replacement" />
            </AcceptanceCriteria>
          </Precept>
          
          <Precept name="TestAdditionalEggs">
            <Constraint>Test each egg individually before use</Constraint>
            <Action>Repeat test for remaining eggs as needed</Action>
          </Precept>
          
          <Output>
            <Artifact name="eggs_validated">
              <Type>instrument</Type>
              <Type>validation_data</Type>
              <Description>Fresh eggs verified for cooking</Description>
            </Artifact>
          </Output>
        </Precept>
      </ValidateInstrumentCondition>

      <ValidateInstrumentCondition instrument="cheese" conditionSet="mold_signs" domain="food_safety">
        <Precept name="InspectCheeseFreshness">
          <AcceptanceCriteria>
            <Condition state="acceptable" test="no_visible_mold" action="Proceed with cooking" />
            <Condition state="questionable" test="slight_discoloration" action="Inspect more closely" />
            <Condition state="unacceptable" test="visible_mold_present" action="Discard and replace" />
          </AcceptanceCriteria>
          <Constraint type="safety">Never use moldy ingredients</Constraint>
          <Output>
            <Artifact name="Cheese_validated">
              <Type>instrument</Type>
              <Type>validation_data</Type>
              <Description>Cheese validated as fresh and suitable for cooking</Description>
            </Artifact>
          </Output>
        </Precept>
      </ValidateInstrumentCondition>
      
      <ValidateInstrumentCondition instrument="butter" conditionSet="rancidity" domain="flavor_quality">
        <Precept name="CheckButterFreshness">
          <AcceptanceCriteria>
            <Condition state="fresh" test="sweet_smell" action="Use for cooking" />
            <Condition state="degraded" test="off_odor" action="Replace with fresh butter" />
          </AcceptanceCriteria>
          <Output>
            <Artifact name="Butter_validated">
              <Type>instrument</Type>
              <Type>validation_data</Type>
              <Description>Butter validated as fresh and suitable for cooking</Description>
            </Artifact>
          </Output>
        </Precept>
      </ValidateInstrumentCondition>
      
      <ValidateInstrumentCondition instrument="pan" conditionSet="clean_non_stick_intact" domain="cooking_equipment">
        <AcceptanceCriteria>
          <Condition state="ready" test="clean_surface_intact_coating" action="Proceed with cooking" />
          <Condition state="damaged" test="scratched_coating" action="Use different pan" />
        </AcceptanceCriteria>
      </ValidateInstrumentCondition>
      
      <Output>
        <Artifact name="instruments_validated">
          <Type>instrument</Type>
          <Type>validation_data</Type>
          <Description>All cooking instruments validated and ready</Description>
        </Artifact>
      </Output>
    </StagingPhase>
    
    <!-- Execution Staging: Combined ingredient and equipment preparation phase -->
    <StagingPhase type="execution" name="ingredient_and_equipment_preparation">
      <RequiredInstrument instrumentName="eggs_validated" providing="preflight" />
      <RequiredInstrument instrumentName="Cheese_validated" providing="preflight" />
      <RequiredInstrument instrumentName="Butter_validated" providing="preflight" />
      <RequiredInstrument instrumentName="instruments_validated" providing="preflight" />
      <Description>Ready all ingredients and equipment concurrently</Description>
      
      <Precept name="equipment_preparation">
        <Precept name="HeatPan" hasSleepableSteps="true">
          <RequiredInstrument instrumentName="pan" providing="preflight">Non-stick pan validated as clean and intact</RequiredInstrument>
          <RequiredInstrument instrumentName="instruments_validated:butter" providing="Butter_validated">Butter validated as fresh and suitable for cooking</RequiredInstrument>
          <Context type="cooking_equipment"/>

          <Action>Place pan on stove</Action>
          <Action>Turn on heat to medium</Action>
          <Action ref="MonitorPanTemperature" sleepable="true">Monitor pan temperature
            <IdleWait duration="1m" reason="Pan heating" />
          </Action>
        </Precept>
      
        <Precept name="AddButter">
          <Action>Add butter to heated pan, swirl to coat</Action>
          <WaitForSignal signal="butter_sizzling_gently" />
        </Precept>
        
        <!-- State vector simplifies to: pan_ready -->
        <Output>
          <Artifact name="pan_ready">
            <Type>instrument</Type>
            <Type>state_vector</Type>
            <Description>Pan heated and buttered, ready for cooking</Description>
          </Artifact>
        </Output>
      </Precept>

      <Precept name="ingredient_preparation">
        <Precept name="CrackEggs" quantity="2-3" into="bowl" />     
        <Precept name="SeasonEggs" with="salt_pepper">
          <Provides>
            <Capability name="SeasonEggs" context="kitchen" />
          </Provides>
          <Action>Season cracked eggs with salt and black pepper to taste</Action>
          <Output>
            <Artifact name="seasoned_eggs">
              <Type>instrument</Type>
              <Description>Cracked eggs seasoned with salt and pepper</Description>
            </Artifact>
          </Output>
        </Precept>
        
        <Precept name="WhiskEggs" until="well_combined">
          <RequiredInstrument instrumentName="seasoned_eggs" providing="SeasonEggs" />
          <Action>Whisk seasoned eggs until yolks and whites are fully blended</Action>
          <Output>
            <Artifact name="whisked_seasoned_eggs">
              <Type>instrument</Type>
              <Description>Pre-stirred and seasoned eggs ready for cooking</Description>
            </Artifact>
          </Output>
        </Precept>
        
        <Precept name="GrateCheese" quantity="50g" type="cheddar_or_gruyere" />
        
        <!-- State vector simplifies to: ingredients_ready -->
        <Output>
          <Artifact name="ingredients_ready">
            <Type>instrument</Type>
            <Type>state_vector</Type>
            <Description>All ingredients prepared and ready for cooking</Description>
            <Source>
              <Union>
                <From ref="WhiskEggs" artifact="whisked_seasoned_eggs" />
                <From ref="GrateCheese" artifact="grated_cheese" />
              </Union>
            </Source>
          </Artifact>
        </Output>
      </Precept>
    </StagingPhase>
        
    <!-- Execution Staging: Base cooking phase -->
    <StagingPhase type="execution" name="base_cooking">
      <RequiredInstrument instrumentName="ingredients_ready" providing="execution:ingredient_and_equipment_preparation" />
      <RequiredInstrument instrumentName="pan_ready" providing="execution:ingredient_and_equipment_preparation" />
      <Description>Cook omelette base until properly set</Description>
      
      <SyncPoint name="PanReadyEggsPrepped">
        <WaitForPrecept ref="AddButter" />
        <WaitForPrecept ref="WhiskEggs" />
        <WaitForPrecept ref="equipment_preparation" />
      </SyncPoint>
      
      <Precept name="PourEggsIntoPan">
        <RequiredInstrument instrumentName="pan_ready" providing="execution:equipment_setup">Pan heated to medium heat with butter sizzling</RequiredInstrument> 
        <RequiredInstrument instrumentName="whisked_seasoned_eggs">Eggs cracked, seasoned, and whisked until well combined</RequiredInstrument>
        <Context type="food_preparation"/>

        <Action>Pour pre-stirred and seasoned eggs into pre-heated, butter-coated pan</Action>
        <Constraint type="technique">Pour smoothly to ensure even distribution</Constraint>
      </Precept>
      
      <Precept name="CookBase">
        <Action>Let eggs set on bottom while stirring gently</Action>
        <IdleWait duration="45s" reason="Base setting" />
        <Constraint type="technique">Gentle circular stirring to prevent sticking and tearing</Constraint>
      </Precept>
      
      <!-- State vector simplifies to: base_ready -->
      <Output>
        <Artifact name="base_ready">
          <Type>instrument</Type>
          <Type>state_vector</Type>
          <Description>Egg base properly set and ready for finishing</Description>
        </Artifact>
      </Output>
    </StagingPhase>
    
    <!-- Execution Staging: Finishing phase -->
    <StagingPhase type="execution" name="finishing">
      <RequiredInstrument instrumentName="base_ready" providing="execution:base_cooking" />
      <Description>Add cheese, fold, and complete omelette</Description>
      
      <Precept name="AddCheese">
        <RequiredInstrument instrumentName="cheese_validated">Cheese validated as fresh and suitable for cooking</RequiredInstrument>
        <Action>Sprinkle grated cheese over half the omelette</Action>
        <Constraint type="placement">Cheese on one half only for folding</Constraint>
      </Precept>
      
      <Precept name="FoldAndFinish">
        <Action>Fold omelette in half</Action>
        <Constraint type="technique">Gentle fold to maintain structure</Constraint>
      </Precept>

      <Precept name="PlateOmelette">
        <Action>Carefully slide omelette onto plate</Action>
        <Constraint type="technique">Use a spatula to maintain shape</Constraint>
      </Precept>

      <Precept name="ResetHeat">
        <Action>Turn off stove to stop cooking</Action>
      </Precept>

      <!-- Final state: completed dish -->
      <Output>
        <Artifact name="finished_omelette">
          <Type>instrument</Type>
          <Type>validation_data</Type>
          <Type>state_vector</Type>
          <Description>Completed omelette plated and ready to serve</Description>
        </Artifact>
      </Output>
    </StagingPhase>
    
    <!-- Context Switch Protocol using staging boundaries -->
    <ContextSwitchProtocol>
      <Step>Preserve staging phase completion status in volatile cache</Step>
      <Step>Store current stage output state vector (simplified)</Step>
      <Step>Log stage boundaries for resumption points</Step>
      <Step>On resumption: validate stage outputs and continue from last completed stage</Step>
    </ContextSwitchProtocol>
    
  </Precept>
</IntentDOM>